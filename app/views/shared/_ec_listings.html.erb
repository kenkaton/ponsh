<div class="mb-6" data-controller="ec-filter">
  <h2 class="font-bold text-lg mb-3 border-l-4 border-gray-500 pl-3">この銘柄を購入</h2>

  <% # コントローラーで準備されたデータを使用、またはフォールバック
    all_listings = local_assigns[:ec_listings] || @ec_listings || entity.ec_listings.available.recent
    available_volumes = local_assigns[:available_volumes] || @available_volumes || EcListing.available_volumes_for(entity)
    available_rice_types = local_assigns[:available_rice_types] || @available_rice_types || EcListing.available_rice_types_for(entity)
    available_platforms = local_assigns[:available_platforms] || @available_platforms || all_listings.map(&:platform).uniq.sort
    available_sake_types = local_assigns[:available_sake_types] || @available_sake_types || 
      begin
        # 酒類分類の表示順序を固定
        sake_type_order = [
          "純米大吟醸酒", "純米吟醸酒", "純米酒",
          "大吟醸酒", "吟醸酒", "本醸造酒", "普通酒"
        ]
        listing_sake_types = all_listings.map(&:sake_type).compact.uniq
        sake_type_order.select { |type| listing_sake_types.include?(type) } +
        (listing_sake_types - sake_type_order).sort
      end
    price_range = local_assigns[:price_range] || @price_range || EcListing.price_range_for(entity)
  %>

  <% if all_listings.any? %>

    <div class="flex flex-col lg:flex-row gap-6">
      <!-- フィルタパネル -->
      <div class="lg:w-1/4">
        <!-- モバイル用フィルタトグル -->
        <button class="lg:hidden w-full mb-3 px-4 py-2 bg-gray-100 rounded text-sm font-medium"
                data-action="click->ec-filter#toggleFilterPanel">
          絞り込み ▼
        </button>

        <div class="filter-panel lg:block hidden bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold text-sm">絞り込み</h3>
            <button class="text-xs text-blue-600 hover:text-blue-800"
                    data-action="click->ec-filter#clearFilters">
              クリア
            </button>
          </div>

          <!-- ソート -->
          <div class="mb-4">
            <h4 class="font-medium text-sm mb-2">並び順</h4>
            <select class="w-full text-sm border rounded px-2 py-1" data-action="change->ec-filter#sortItems">
              <option value="recent">更新日順</option>
              <option value="price-asc">価格の安い順</option>
              <option value="price-desc">価格の高い順</option>
              <option value="value">コスパの良い順</option>
              <option value="review">レビューの良い順</option>
            </select>
          </div>

          <!-- 価格範囲 -->
          <% if price_range[0] < price_range[1] %>
            <div class="mb-4">
              <h4 class="font-medium text-sm mb-2">価格帯</h4>
              <div class="space-y-2">
                <input type="range"
                       min="<%= price_range[0] %>"
                       max="<%= price_range[1] %>"
                       value="<%= price_range[1] %>"
                       class="w-full"
                       data-ec-filter-target="priceRange"
                       data-action="input->ec-filter#filterByPrice">
                <div class="flex justify-between text-xs text-gray-500">
                  <span>¥<%= ActiveSupport::NumberHelper.number_to_delimited(price_range[0]) %></span>
                  <span>¥<%= ActiveSupport::NumberHelper.number_to_delimited(price_range[1]) %></span>
                </div>
                <div class="text-xs text-center" data-ec-filter-target="priceDisplay">
                  上限: ¥<%= ActiveSupport::NumberHelper.number_to_delimited(price_range[1]) %>
                </div>
              </div>
            </div>
          <% end %>

          <!-- 内容量フィルタ -->
          <% if available_volumes.any? %>
            <div class="mb-4">
              <h4 class="font-medium text-sm mb-2">内容量</h4>
              <div class="space-y-1">
                <% available_volumes.each do |volume| %>
                  <label class="flex items-center text-sm">
                    <input type="checkbox"
                           class="mr-2"
                           data-ec-filter-target="filter"
                           data-filter-type="volume"
                           data-filter-value="<%= volume %>"
                           data-action="change->ec-filter#filter">
                    <%= volume >= 1000 ? "#{volume / 1000.0}L" : "#{volume}ml" %>
                    <span class="text-gray-500 ml-auto text-xs">
                      <%= all_listings.select { |l| l.volume_ml == volume }.count %>件
                    </span>
                  </label>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 原料米フィルタ -->
          <% if available_rice_types.any? %>
            <div class="mb-4">
              <h4 class="font-medium text-sm mb-2">原料米</h4>
              <div class="space-y-1">
                <% available_rice_types.each do |rice| %>
                  <label class="flex items-center text-sm">
                    <input type="checkbox"
                           class="mr-2"
                           data-ec-filter-target="filter"
                           data-filter-type="rice"
                           data-filter-value="<%= rice %>"
                           data-action="change->ec-filter#filter">
                    <%= rice %>
                    <span class="text-gray-500 ml-auto text-xs">
                      <%= all_listings.select { |l| l.rice_type == rice }.count %>件
                    </span>
                  </label>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- 酒類分類フィルタ -->
          <% if available_sake_types.any? %>
            <div class="mb-4">
              <h4 class="font-medium text-sm mb-2">酒類分類</h4>
              <div class="space-y-1">
                <% available_sake_types.each do |sake_type| %>
                  <label class="flex items-center text-sm">
                    <input type="checkbox"
                           class="mr-2"
                           data-ec-filter-target="filter"
                           data-filter-type="sakeType"
                           data-filter-value="<%= sake_type %>"
                           data-action="change->ec-filter#filter">
                    <%= sake_type %>
                    <span class="text-gray-500 ml-auto text-xs">
                      <%= all_listings.select { |l| l.sake_type == sake_type }.count %>件
                    </span>
                  </label>
                <% end %>
              </div>
            </div>
          <% end %>

          <!-- モールフィルタ -->
          <div class="mb-4">
            <h4 class="font-medium text-sm mb-2">モール</h4>
            <div class="space-y-1">
              <% available_platforms.each do |platform| %>
                <label class="flex items-center text-sm">
                  <input type="checkbox"
                         class="mr-2"
                         data-ec-filter-target="filter"
                         data-filter-type="platform"
                         data-filter-value="<%= platform %>"
                         data-action="change->ec-filter#filter">
                  <%= platform == "rakuten" ? "楽天市場" : "Amazon" %>
                  <span class="text-gray-500 ml-auto text-xs">
                    <%= all_listings.select { |l| l.platform == platform }.count %>件
                  </span>
                </label>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- 商品リスト -->
      <div class="lg:w-3/4">
        <div class="mb-3 text-sm text-gray-600">
          <span data-ec-filter-target="resultCount"><%= all_listings.count %></span>件の商品が見つかりました
        </div>

        <div class="space-y-3" data-ec-filter-target="itemContainer">
          <% all_listings.each do |listing| %>
            <div class="border rounded-lg p-3 sm:p-4 hover:shadow-lg transition-shadow"
                 data-ec-filter-target="item"
                 data-volume="<%= listing.volume_ml %>"
                 data-rice="<%= listing.rice_type %>"
                 data-platform="<%= listing.platform %>"
                 data-price="<%= listing.price %>"
                 data-value-score="<%= listing.value_score %>"
                 data-review-average="<%= listing.review_average || 0 %>"
                 data-updated-at="<%= listing.last_updated_at&.to_i %>"
                 data-sake-type="<%= listing.sake_type %>">

              <a href="<%= listing.affiliate_url %>" target="_blank" rel="noopener noreferrer" class="flex gap-3 sm:gap-4">
                <div class="flex-shrink-0">
                  <% if listing.image_url.present? && !listing.image_url.include?("now_printing.jpg") %>
                    <%= image_tag listing.image_url,
                        alt: listing.product_name,
                        class: "w-20 h-20 sm:w-32 sm:h-32 object-contain rounded",
                        loading: "lazy" %>
                  <% else %>
                    <!-- 画像プレースホルダー -->
                    <div class="w-20 h-20 sm:w-32 sm:h-32 bg-gray-100 rounded flex items-center justify-center">
                      <svg class="w-8 h-8 sm:w-12 sm:h-12 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                        <!-- 日本酒ボトルアイコン -->
                        <path d="M9 2h6v5.5c1.5.5 2.5 2 2.5 3.5v9c0 1.1-.9 2-2 2h-7c-1.1 0-2-.9-2-2v-9c0-1.5 1-3 2.5-3.5V2zm2 2v3.3c-.3-.1-.6-.2-1-.2s-.7.1-1 .2V4h2zm3 0v3.3c.3.1.6.2 1 .2V4h-1zm-5 6c-1.1 0-2 .9-2 2v8h10v-8c0-1.1-.9-2-2-2H9z"/>
                      </svg>
                    </div>
                  <% end %>
                </div>

                <div class="flex-1 min-w-0">
                  <div class="flex items-start justify-between mb-2">
                    <h3 class="text-xs sm:text-sm font-medium line-clamp-2 flex-1 pr-2">
                      <%= listing.product_name %>
                    </h3>
                    <!-- プラットフォームバッジ -->
                    <span class="flex-shrink-0 text-xs px-2 py-1 rounded <%= listing.platform == 'rakuten' ? 'bg-red-100 text-red-700' : 'bg-orange-100 text-orange-700' %>">
                      <%= listing.platform_name %>
                    </span>
                  </div>

                  <div class="flex items-center gap-2 sm:gap-3 flex-wrap mb-2">
                    <!-- 価格 -->
                    <span class="text-base sm:text-lg font-bold <%= listing.platform == 'rakuten' ? 'text-red-600' : 'text-orange-600' %>">
                      <%= listing.formatted_price %>
                    </span>

                  </div>

                  <div class="flex items-center gap-2 sm:gap-3 flex-wrap mb-2 text-xs text-gray-600">
                    <!-- レビュー -->
                    <% if listing.review_average&.positive? %>
                      <span class="flex items-center">
                        <span class="text-yellow-500 mr-1">★</span>
                        <%= listing.review_average.round(1) %>
                        <span class="text-gray-500 ml-1">(<%= listing.review_count %>)</span>
                      </span>
                    <% end %>

                    <!-- 内容量 -->
                    <% if listing.volume_display %>
                      <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">
                        <%= listing.volume_display %>
                      </span>
                    <% end %>

                    <!-- 原料米 -->
                    <% if listing.rice_type.present? %>
                      <span class="bg-purple-100 text-purple-700 px-2 py-1 rounded">
                        <%= listing.rice_type %>
                      </span>
                    <% end %>

                    <!-- 酒類分類 -->
                    <% if listing.sake_type.present? %>
                      <span class="bg-indigo-100 text-indigo-700 px-2 py-1 rounded">
                        <%= listing.sake_type %>
                      </span>
                    <% end %>

                    <!-- 日本酒度 -->
                    <% if listing.sake_meter_value.present? %>
                      <span class="bg-cyan-100 text-cyan-700 px-2 py-1 rounded">
                        日本酒度: <%= listing.sake_meter_value > 0 ? '+' : '' %><%= listing.sake_meter_value %>
                      </span>
                    <% end %>

                    <!-- 酸度 -->
                    <% if listing.acidity.present? %>
                      <span class="bg-teal-100 text-teal-700 px-2 py-1 rounded">
                        酸度: <%= listing.acidity %>
                      </span>
                    <% end %>

                    <!-- JANコード -->
                    <% if listing.jan_code.present? %>
                      <span class="text-xs text-gray-400">
                        JAN: <%= listing.jan_code %>
                      </span>
                    <% end %>
                  </div>

                  <div class="flex items-center justify-between">
                    <span class="text-xs text-gray-500">
                      <%= listing.shop_name || listing.platform_name %>
                    </span>

                    <span class="inline-block <%= listing.platform == 'rakuten' ? 'bg-red-600' : 'bg-orange-600' %> text-white text-xs px-3 py-1 rounded">
                      <%= listing.platform == 'rakuten' ? '楽天で見る' : 'Amazonで見る' %>
                    </span>
                  </div>
                </div>
              </a>
            </div>
          <% end %>
        </div>

        <!-- 結果なし表示 -->
        <div class="hidden text-center py-8 text-gray-500" data-ec-filter-target="noResults">
          <div class="mb-4">
            <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          該当する商品が見つかりませんでした。<br>
          フィルタ条件を変更してお試しください。
        </div>

        <!-- もっと見るリンク -->
        <div class="mt-6 text-center space-y-2">
          <a href="https://search.rakuten.co.jp/search/mall/<%= CGI.escape(entity.name + ' 日本酒') %>/"
             target="_blank"
             rel="noopener noreferrer"
             class="inline-block text-blue-600 hover:text-blue-800 text-sm mr-4">
            楽天市場でもっと見る →
          </a>
          <a href="https://www.amazon.co.jp/s?k=<%= CGI.escape(entity.name + ' 日本酒') %>"
             target="_blank"
             rel="noopener noreferrer"
             class="inline-block text-blue-600 hover:text-blue-800 text-sm">
            Amazonでもっと見る →
          </a>
        </div>
      </div>
    </div>
  <% else %>
    <!-- 商品情報がない場合 -->
    <div class="bg-gray-50 rounded-lg p-6 text-center">
      <div class="mb-4">
        <svg class="w-12 h-12 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l-1 10a2 2 0 01-2 2H8a2 2 0 01-2-2L5 9z"></path>
        </svg>
      </div>
      <p class="text-gray-600 mb-4">現在、オンラインショップの商品情報を取得中です。</p>
      <div class="flex justify-center gap-4">
        <a href="https://search.rakuten.co.jp/search/mall/<%= CGI.escape(entity.name + ' 日本酒') %>/"
           target="_blank"
           rel="noopener noreferrer"
           class="inline-block bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition-colors">
          楽天市場で検索
        </a>
        <a href="https://www.amazon.co.jp/s?k=<%= CGI.escape(entity.name + ' 日本酒') %>"
           target="_blank"
           rel="noopener noreferrer"
           class="inline-block bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 transition-colors">
          Amazonで検索
        </a>
      </div>
    </div>
  <% end %>
</div>
